#!/bin/bash

# A script to semi automate the packages update procedure and cleanup on Debian based
# distributions using the apt package manager and other packages.
# Version: 0.6

sudo_check_() {
    sudo -v || exit 1
}

sources_() {
    clear
    find /etc/apt/ -type f -iname *.list -printf "%f\n"
    
    read -p "Enter source list file to edit: " sourcelist

    if [ "$sourcelist" == "sources.list" ]; then
        sourcelist=""
    fi

    # edit-sources using default system editor
    sudo apt edit-sources $sourcelist
    
    read -p "Would you like to update the package repositories? [Y/n]: " answer
    
    if [ "$answer" == "y" ] || [ "$answer" == "Y" ] || [ "$answer" == "" ]; then
        sudo apt update
    fi
}

# Check some packages and nofity user if installed
pkgs_check() {
    if [ ! -z $(which aptitude) ]; then
        check_apti=""
    else
        check_apti="Not installed"
    fi

    if [ ! -z $(which deborphan) ]; then
        check_debo=""
    else
        check_debo="Not installed"
    fi
}

# View help now in terminal using curl
help_() {
    curl -s https://raw.githubusercontent.com/sianios/dotfiles/master/update.md | less -N
}

pkgs_check

_VERSION="0.6"

MENU="1 - Update
2 - Upgrade
3 - Full-Upgrade
L - List Available Upgrades

C - apt Clean
A - Autoremove
O - Remove Obsolete Packages using aptitude "$check_apti"
D - Purge Packages using deborphan "$check_debo"

V - View apt history log
E - Edit source.list files
H - Info and help

Q - Exit"

while true; do
    clear
    echo -e "${MENU}"
    echo -n "Enter option: "
    read option
    case $option in
        1) sudo apt update ;;
        2) sudo apt upgrade -V ;;
        3) sudo apt full-upgrade ;;
        l|L) apt list --upgradable 
            read -p "Press Enter to continue" ;;
        a|A) sudo apt autoremove --purge ;;
        o|O) sudo aptitude purge ~o ;;
        d|D) sudo apt purge $(deborphan) ;;
        c|C) sudo apt clean ;; # Clean localy downloaded packages
        v|V) less -N /var/log/apt/history.log ;;
        e|E) sources_ ;;
        h|H) help_ ;;
        q|Q) exit 0 ;;
        ?*) echo "Error: $option option is not valid. Try again.."
            sleep 2 ;;
    esac
done
